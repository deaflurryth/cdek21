import requests

from typing import Dict, Optional
from boltons.iterutils import remap


class CDEK2Client:
    __CDEK_URL = 'https://api.edu.cdek.ru'
    __AUTH_URL = '/v2/oauth/token?parameters'
    __DELIVERY_POINTS_URL = '/v2/deliverypoints'
    __DELIVERY_COST_URL = '/v2/calculator/tarifflist'
    __HEADER_REQUEST = None

    def __init__(
            self,
            client_id: str,
            client_secret: str,
            grant_type: str = 'client_credentials',
    ):
        # Генерация заголовка запроса.
        self.__HEADER_REQUEST = self.__get_header_request(
            grant_type=grant_type,
            client_id=client_id,
            client_secret=client_secret)

    def __exec_request(
            self,
            url: str,
            data: Dict = None,
            method: str = 'GET',
    ) -> requests.Response:
        '''
        Возвращает ответ сервера на отправленный запрос.

        url - Путь к требуемому методу.
        data - Параметры запроса.
        method - POST/GET.
        '''

        if isinstance(data, dict):
            data = remap(data, lambda p, k, v: v is not None)

        url = self.__CDEK_URL + url

        if method == 'GET':
            response = requests.get(
                url=url,
                headers=self.__HEADER_REQUEST,
                params=data)
        elif method == 'POST':
            if self.__HEADER_REQUEST == None:
                response = requests.post(
                    url=url,
                    params=data)
            else:
                response = requests.post(
                    url=url,
                    headers=self.__HEADER_REQUEST,
                    json=data)
        else:
            raise NotImplementedError(f'Unknown method "{method}"')

        response.raise_for_status()

        return response

    def __get_header_request(
            self,
            grant_type: str,
            client_id: str,
            client_secret: str
    ) -> Dict[str, str]:
        '''
        Возвращает заголовок запроса с токеном авторизации
        и форматом JSON (Content-Type: application/json).

        grant_type - Тип аутентификации, доступное значение.
        client_id - идентификатор клиента, равен Accoun.
        client_secret - секретный ключ клиента, равен Secure password.
        '''
        data = {
            'grant_type': grant_type,
            'client_id': client_id,
            'client_secret': client_secret,
        }
        response = self.__exec_request(
            url=self.__AUTH_URL,
            data=data,
            method='POST',
        ).json()

        access_token = response['token_type'].capitalize() + \
                       ' ' + response['access_token']
        header = {
            'Authorization': access_token,
            'Content-Type': 'application/json',
            'Accept': 'application/json',
        }
        return header

    def get_delivery_points(
            self,
            city_code: int = None,
            type: str = 'PVZ',
            country_code: str = 'RU',
    ) -> Optional[Dict]:
        '''
        Возвращает пункты выдачи заказов.

        city_code - Код населенного пункта СДЭК.
        type - Тип офиса, может принимать значения (PVZ/POSTAMAT/ALL).
        country_code - Код страны в формате ISO_3166-1_alpha-2.
        '''

        data = {
            'city_code': city_code,
            'type': type,
            'country_code': country_code,
        }
        response = self.__exec_request(
            url=self.__DELIVERY_POINTS_URL,
            data=data,
        ).json()
        return response

    def get_delivery_cost(
            self,
            sender_city_code: int,
            receiver_city_code: int,
            goods: Optional[Dict],
            tariff_code: int = 483,  # Экспресс склад-склад.
    ) -> Dict:
        '''
        Возвращает стоимость доставки.

        sender_city_code - Код населенного пункта отправителя СДЭК.
        receiver_city_code - Код населенного пункта получателя СДЭК.
        goods - Товары в виде списка, пример:
        [
            {
                'weight': 1000,
                'length': 10,
                'width': 10,
                'height': 10,
            },
        ]
        tariff_code - Код тарифа СДЭК.
        '''
        data = {
            'tariff_code': tariff_code,
            'from_location': {
                'code': sender_city_code,
            },
            'to_location': {
                'code': receiver_city_code,
            },
            'packages': goods,
        }
        response = self.__exec_request(
            url=self.__DELIVERY_COST_URL,
            data=data,
            method='POST',
        ).json()
        return response
#

# Создаем экземпляр класса
client = CDEK2Client(client_id="EMscd6r9JnFiQ3bLoyjJY6eM78JrJceI", client_secret="PjLZkKBHEiLK3YsjtNrt3TGNG0ahs3kG")

# Замените коды городов на нужные значения
sender_city_code = 11
receiver_city_code = 21

# Задаем информацию о товаре
goods = [
    {
        'weight': 1000,
        'length': 10,
        'width': 15,
        'height': 20,
    }
]

# # Вызываем метод для расчета стоимости доставки
# response = client.get_delivery_cost(sender_city_code, receiver_city_code, goods)
# print(response)
#

dict_city_code = {
  "Пермь": 22,
  "Абакан": 74,
  "Зеленодольск": 39,
  "Санкт-Петербург": 82,
  "Нижневартовск": 11,
  "Волжск": 32,
  "Екатеринбург": 24,
  "Ставрополь": 19,
  "Апатиты": 43,
  "Красное Село": 82,
  "Киселёвск": 54,
  "Москва": 81,
  "Омск": 15,
  "Владивосток": 18,
  "Октябрьский": 27,
  "Ростов-на-Дону": 45,
  "Саратов": 47,
  "Нижний Новгород": 67,
  "Новосибирск": 23,
  "Улан-Удэ": 12,
  "Волоколамск": 9,
  "Алексин": 37,
  "Балашиха": 9,
  "Казань": 39,
  "Тюмень": 52,
  "Барнаул": 2,
  "Сочи": 7,
  "Севастополь": 975,
  "Новоалтайск": 2,
  "Рязань": 41,
  "Подольск": 9,
  "Алушта": 90,
  "Петрозаводск": 73,
  "Светлоград": 19,
  "Прокопьевск": 54,
  "Александров": 17,
  "Томск": 53,
  "Мончегорск": 43,
  "Алексеевка": 16,
  "Ангарск": 4,
  "Серов": 24,
  "Заволжье": 67,
  "Муром": 17,
  "Южноуральск": 3,
  "Армавир": 7,
  "Чебоксары": 64,
  "Арзамас": 67,
  "Ярославль": 35,
  "Похвистнево": 57,
  "Архангельск": 66,
  "Челябинск": 3,
  "Мирный": 10,
  "Реутов": 9,
  "Ялуторовск": 52,
  "Аша": 3,
  "Тольятти": 57,
  "Апрелевка": 9,
  "Альметьевск": 39,
  "Балахна": 67,
  "Оренбург": 5,
  "Астрахань": 34,
  "Лесосибирск": 13,
  "Наро-Фоминск": 9,
  "Воронеж": 63,
  "Набережные Челны": 39,
  "Артем": 18,
  "Анапа": 7,
  "Нижний Тагил": 24,
  "Рузаевка": 68,
  "Павловский Посад": 9,
  "Азов": 45,
  "Рыбинск": 35,
  "Раменское": 9,
  "Тула": 37,
  "Березовский": 24,
  "Белебей": 27,
  "Сургут": 11,
  "Северный": 16,
  "Полевской": 24,
  "Великий Новгород": 31,
  "Юрга": 54,
  "Асино": 53,
  "Бахчисарай": 90,
  "Махачкала": 21,
  "Кострома": 42,
  "Ижевск": 48,
  "Назарово": 13,
  "Лобня": 9,
  "Таганрог": 45,
  "Красноярск": 13,
  "Нягань": 11,
  "Благовещенск": 56,
  "Симферополь": 90,
  "Балабаново": 33,
  "Северодвинск": 66,
  "Ялта": 90,
  "Белореченск": 7,
  "Клин": 9,
  "Сходня": 9,
  "Амурск": 14,
  "Балаково": 47,
  "Белорецк": 27,
  "Кунгур": 22,
  "Серпухов": 9,
  "Ульяновск": 70,
  "Керчь": 90,
  "Пушкин": 82,
  "Кисловодск": 19,
  "Луховицы": 9,
  "Хабаровск": 14,
  "Борисоглебск": 63,
  "Маркс": 47,
  "Брянск": 29,
  "Учалы": 27,
  "Надым": 6,
  "Шадринск": 28,
  "Бронницы": 9,
  "Бор": 67,
  "Краснодар": 7,
  "Ачинск": 13,
  "Путилково": 9,
  "Биробиджан": 76,
  "Белгород": 16,
  "Бийск": 2,
  "Батайск": 45,
  "Благодарный": 19,
  "Ишим": 52,
  "Бутово": 81,
  "Жуковский": 9,
  "Югорск": 11,
  "Липецк": 60,
  "Буденновск": 19,
  "Бугульма": 39,
  "Бузулук": 5,
  "Волгоград": 40,
  "Курчатов": 62,
  "Рославль": 65,
  "Щелково": 9,
  "Самара": 57,
  "Пенза": 69,
  "Абинск": 7,
  "Магнитогорск": 3,
  "Ногинск": 9,
  "Салават": 27,
  "Ханты-Мансийск": 11,
  "Чебаркуль": 3,
  "Мурино": 26,
  "Магадан": 59,
  "Туймазы": 27,
  "Кстово": 67,
  "Усть-Лабинск": 7,
  "Дубна": 9,
  "Междуреченск": 54,
  "Орехово-Зуево": 9,
  "Лермонтов": 19,
  "Снежинск": 3,
  "Волгодонск": 45,
  "Стерлитамак": 27,
  "Нальчик": 78,
  "Сколково инновационный центр": 81,
  "Южно-Сахалинск": 20,
  "Тверь": 50,
  "Шаховская": 9,
  "Чернушка": 22,
  "Черногорск": 74,
  "Черноголовка": 9,
  "Красноармейск": 9,
  "Чехов": 9,
  "Мурманск": 43,
  "Новочеркасск": 45,
  "Черноморское": 90,
  "Черкесск": 80,
  "Киров": 44,
  "Череповец": 51,
  "Чусовой": 22,
  "Ессентуки": 19,
  "Чита": 49,
  "Десеновское": 81,
  "Долгопрудный": 9,
  "Котельники": 9,
  "Владимир": 17,
  "Домодедово": 9,
  "Димитровград": 70,
  "Иркутск": 4,
  "Дзержинский": 9,
  "Джанкой": 90,
  "Динская": 7,
  "Донецк": 45,
  "Забайкальск": 49,
  "Дрожжино": 9,
  "Псков": 30,
  "Северская": 7,
  "Дзержинск": 67,
  "Зеленоград": 9,
  "Боровичи": 31,
  "Воскресенское поселение": 81,
  "Сысерть": 24,
  "Йошкар-Ола": 32,
  "Покров": 17,
  "Новокузнецк": 54,
  "Ново-Переделкино": 9,
  "Судак": 90,
  "Покровка": 18,
  "Павлово": 67,
  "Электрогорск": 9,
  "Железнодорожный": 9,
  "Чистополь": 39,
  "Тамбов": 58,
  "Электроугли": 9,
  "Елизово": 55,
  "Энгельс": 47,
  "Электросталь": 9,
  "Евпатория": 90,
  "Орел": 36,
  "Феодосия": 90,
  "Галич": 42,
  "Губкин": 16,
  "Гуково": 45,
  "Химки": 9,
  "Геленджик": 7,
  "Соликамск": 22,
  "Глазов": 48,
  "Уссурийск": 18,
  "Городец": 67,
  "Сергиев Посад": 9,
  "Железноводск": 19,
  "Горно-Алтайск": 25,
  "Пятигорск": 19,
  "Георгиевск": 19,
  "Грязи": 60,
  "Выкса": 67,
  "Петропавловск-Камчатский": 55,
  "Горелово": 82,
  "Урюпинск": 40,
  "Грозный": 71,
  "Уфа": 27,
  "Лениногорск": 39,
  "Тайшет": 4,
  "Люберцы": 9,
  "Борзя": 49,
  "Новый Уренгой": 6,
  "Дмитров": 9,
  "Ахтубинск": 34,
  "Губаха": 22,
  "Кубинка": 9,
  "Новотроицк": 5,
  "Находка": 18,
  "Минеральные Воды": 19,
  "Игра": 48,
  "Иноземцево": 19,
  "Троицк": 9,
  "Руза": 9,
  "Курганинск": 7,
  "Асбест": 24,
  "Куровское": 9,
  "Аксай": 45,
  "Приморско-Ахтарск": 7,
  "Анжеро-Судженск": 54,
  "Иваново": 8,
  "Истра": 9,
  "Старая Купавна": 9,
  "Березники": 22,
  "Краснотурьинск": 24,
  "Ирбит": 24,
  "Голицыно": 9,
  "Ивангород": 26,
  "Гусь-Хрустальный": 17,
  "Апшеронск": 7,
  "Протвино": 9,
  "Сызрань": 57,
  "Салехард": 6,
  "Бирск": 27,
  "Невинномысск": 19,
  "Гатчина": 26,
  "Владикавказ": 79,
  "Ивантеевка": 9,
  "Горячий Ключ": 7,
  "Минусинск": 13,
  "Изобильный": 19,
  "Красногорск": 9,
  "Саки": 90,
  "Сальск": 45,
  "Качканар": 24,
  "Коммунарка": 9,
  "Канск": 13,
  "Братск": 4,
  "Нефтеюганск": 11,
  "Губкинский": 6,
  "Кудымкар": 22,
  "Кемерово": 54,
  "Сертолово": 26,
  "Сыктывкар": 1,
  "Арсеньев": 18,
  "Шуя": 8,
  "Когалым": 11,
  "Химки Новые": 9,
  "Хотьково": 9,
  "Кимры": 50,
  "Кинешма": 8,
  "Кировск": 26,
  "Кизляр": 21,
  "Калининград": 38,
  "Калуга": 33,
  "Каменск-Уральский": 24,
  "Строитель": 58,
  "Коломна": 9,
  "Колпино": 82,
  "Советский": 11,
  "Камышлов": 24,
  "Камышин": 40,
  "Кингисепп": 26,
  "Канаш": 64,
  "Котельнич": 44,
  "Кольцово": 50,
  "Кольчугино": 17,
  "Комсомольск-на-Амуре": 14,
  "Тарасково": 9,
  "Конаково": 50,
  "Тосно": 26,
  "Котлас": 66,
  "Копейск": 3,
  "Красноперекопск": 90,
  "Краснокамск": 22,
  "Красная Поляна": 7,
  "Королев": 9,
  "Урай": 11,
  "Крымск": 7,
  "Кропоткин": 7,
  "Курск": 62,
  "Кириши": 26,
  "Воскресенск": 9,
  "Ковров": 17,
  "Кронштадт": 82,
  "Киржач": 17,
  "Краснообск": 23,
  "Вятские Поляны": 44,
  "Якутск": 10,
  "Красноуфимск": 24,
  "Каменск-Шахтинский": 45,
  "Климовск": 9,
  "Кыштым": 3,
  "Кашира": 9,
  "Звенигород": 9,
  "Ступино": 9,
  "Монино": 9,
  "Элиста": 46,
  "Клинцы": 29,
  "Мытищи": 9,
  "Шатура": 9,
  "Вышний Волочёк": 50,
  "Восточный мкр.": 9,
  "Шушары": 82,
  "Североуральск": 24,
  "Сухой Лог": 24,
  "Курган": 28,
  "Искитим": 23,
  "Бердск": 23,
  "Трехгорный": 3,
  "Новошахтинск": 45,
  "Вельск": 66,
  "Ревда": 24,
  "Ефремов": 37,
  "Майкоп": 61,
  "Златоуст": 3,
  "Мосрентген": 9,
  "Нахабино": 9,
  "Белово": 54,
  "Торжок": 50,
  "Солнечногорск": 9,
  "Белая Калитва": 45,
  "Фрязино": 9,
  "Коротчаево": 6,
  "Чайковский": 22,
  "Орск": 5,
  "Заводоуковск": 52,
  "Острогожск": 63,
  "Щербинка": 9,
  "Обнинск": 33,
  "Егорьевск": 9,
  "Солнцево": 9,
  "Невьянск": 24,
  "Мелеуз": 27,
  "Лангепас": 11,
  "Лабинск": 7,
  "Людиново": 33,
  "Ликино-Дулево": 9,
  "Лиски": 63,
  "Ленинск-Кузнецкий": 54,
  "Лесной": 24,
  "Луга": 26,
  "Лыткарино": 9,
  "Малаховка": 9,
  "Мегион": 11,
  "Миасс": 3,
  "Мичуринск": 58,
  "Миллерово": 45,
  "Михайловка": 40,
  "Михайловск": 19,
  "Московский": 9,
  "Можайск": 9,
  "Митино": 81,
  "Новокуйбышевск": 57,
  "Ноябрьск": 6,
  "Некрасовка": 9,
  "Нефтекамск": 27,
  "Новомосковск": 37,
  "Новоалександровск": 19,
  "Нерюнгри": 10,
  "Нарьян-Мар": 77,
  "Норильск": 13,
  "Новоуральск": 24,
  "Нижняя Тура": 24,
  "Новочебоксарск": 64,
  "Новороссийск": 7,
  "Нижнекамск": 39,
  "Назрань": 72,
  "Обухово": 9,
  "Одинцово": 9,
  "Озерск": 3,
  "Островцы": 9,
  "Отрадный": 57,
  "Петергоф (Петродворец)": 82,
  "Пограничный": 18,
  "Приозерск": 26,
  "Пушкино": 9,
  "Сарапул": 48,
  "Первоуральск": 24,
  "Рубцовск": 2,
  "Россошь": 63,
  "Ржев": 50,
  "Саров": 67,
  "Саяногорск": 74,
  "Северный (Москва)": 9,
  "Софрино": 9,
  "Шарыпово": 13,
  "Щекино": 37,
  "Шахты": 45,
  "Славянск-на-Кубани": 7,
  "Смоленск": 65,
  "Старый Оскол": 16,
  "Саранск": 68,
  "Сосновый Бор": 26,
  "Сестрорецк": 82,
  "Стрежевой": 53,
  "Северск": 53,
  "Талнах": 13,
  "Тобольск": 52,
  "Томилино": 9,
  "Тимашевск": 7,
  "Тихорецк": 7,
  "Тихвин": 26,
  "Темрюк": 7,
  "Туапсе": 7,
  "Цимлянск": 45,
  "Тавда": 24,
  "Усолье-Сибирское": 4,
  "Успенское": 9,
  "Выборг": 26,
  "Ухта": 1,
  "Видное": 9,
  "Великий Устюг": 51,
  "Вологда": 51,
  "Волжский": 40,
  "Волхов": 26,
  "Великие Луки": 30,
  "ВНИИССОК": 9,
  "Верхняя Пышма": 24,
  "Всеволожск": 26,
  "Воткинск": 48,
  "Вязьма": 65,
  "Вязники": 17,
  "Яблоновский": 7,
  "Юбилейный": 9,
  "Ярцево": 65,
  "Елабуга": 39,
  "Елец": 60,
  "Ейск": 7,
  "Юрюзань": 3,
  "Заинск": 39,
  "Зерноград": 45,
  "Зеленокумск": 19,
  "Железногорск": 62,
  "Зеленогорск": 13,
  "Заринск": 2,
  "Заречный": 24
}